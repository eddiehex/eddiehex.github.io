<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shark Blog</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/prism-code.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="icon" href="https://hexo.kygoho.win/upload/uploads/6e7cf36d-8cb2-40c6-831f-80ef7488cca4.png" type="image/x-icon">
  <link rel="stylesheet" href="/css/toc.css">
  
  <!-- MathJax Configuration -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true,
        packages: ['base', 'ams', 'noerrors', 'noundefined']
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      },
      startup: {
        ready() {
          MathJax.startup.defaultReady();
          // Re-render math when content changes
          document.addEventListener('DOMContentLoaded', function() {
            if (window.MathJax && window.MathJax.typesetPromise) {
              window.MathJax.typesetPromise();
            }
          });
        }
      }
    };
  </script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
  <header>
    <nav>
      <div class="nav-container">
        <div class="logo"><a href="/">Shark Blog</a></div>
        <div class="search-container">
          <input type="text" id="search-input" placeholder="Search...">
          <div id="search-results"></div>
        </div>
        <div class="menu-toggle">
          <i class="fas fa-bars"></i>
        </div>
      </div>
      <ul class="nav-links">
        <li><a href="/">Posts</a></li>
        <li><a href="/services">Services</a></li>
        <li><a href="/archives">Archive</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="page-container">
  
    <div class="toc-card">
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E7%90%86%E8%A7%A3%E4%B8%8E%E6%8E%A2%E7%B4%A2"><span class="toc-text">一、数据理解与探索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E6%A6%82%E8%A7%88"><span class="toc-text">1. 数据概览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E6%9E%90"><span class="toc-text">2. 可视化分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97"><span class="toc-text">二、数据清洗</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%A4%84%E7%90%86%E7%BC%BA%E5%A4%B1%E5%80%BC"><span class="toc-text">1. 处理缺失值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8%E5%80%BC"><span class="toc-text">2. 处理异常值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%89%B9%E5%BE%81%E6%9E%84%E5%BB%BA"><span class="toc-text">三、特征构建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%95%B0%E5%80%BC%E5%9E%8B%E7%89%B9%E5%BE%81%E5%A4%84%E7%90%86"><span class="toc-text">1. 数值型特征处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%B1%BB%E5%88%AB%E5%9E%8B%E7%89%B9%E5%BE%81%E7%BC%96%E7%A0%81"><span class="toc-text">2. 类别型特征编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E7%89%B9%E5%BE%81"><span class="toc-text">3. 时间序列特征</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E7%89%B9%E5%BE%81%E5%8F%98%E6%8D%A2"><span class="toc-text">四、特征变换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%A0%87%E5%87%86%E5%8C%96-%E5%BD%92%E4%B8%80%E5%8C%96"><span class="toc-text">1. 标准化&#x2F;归一化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%9D%9E%E7%BA%BF%E6%80%A7%E5%8F%98%E6%8D%A2"><span class="toc-text">2. 非线性变换</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%89%B9%E5%BE%81%E9%80%89%E6%8B%A9"><span class="toc-text">五、特征选择</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%BF%87%E6%BB%A4%E6%B3%95"><span class="toc-text">1. 过滤法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8C%85%E8%A3%B9%E6%B3%95%EF%BC%88%E9%80%92%E5%BD%92%E7%89%B9%E5%BE%81%E6%B6%88%E9%99%A4%EF%BC%89"><span class="toc-text">2. 包裹法（递归特征消除）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B5%8C%E5%85%A5%E6%B3%95%EF%BC%88%E5%9F%BA%E4%BA%8E%E6%A8%A1%E5%9E%8B%EF%BC%89"><span class="toc-text">3. 嵌入法（基于模型）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E7%89%B9%E5%BE%81%E9%99%8D%E7%BB%B4"><span class="toc-text">六、特征降维</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-PCA"><span class="toc-text">1. PCA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-t-SNE"><span class="toc-text">2. t-SNE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E7%89%B9%E5%BE%81%E5%AD%98%E5%82%A8"><span class="toc-text">七、特征存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E5%A4%84%E7%90%86%E5%90%8E%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">保存处理后的数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7"><span class="toc-text">八、高级技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%87%AA%E5%8A%A8%E5%8C%96%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="toc-text">1. 自动化特征工程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%A4%84%E7%90%86%E9%AB%98%E5%9F%BA%E6%95%B0%E7%B1%BB%E5%88%AB%E7%89%B9%E5%BE%81"><span class="toc-text">2. 处理高基数类别特征</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li></ol>
      </div>
    </div>
  
  
  <article class="page-content">
    <h1 class="page-title">Feature Engineering by Python and Pyspark</h1>
    <div class="page-body">
      <p>特征工程是机器学习流程中至关重要的环节，直接影响模型性能。以下是详细的步骤说明及对应的Python&#x2F;PySpark实现代码：</p>
<hr>
<h3 id="一、数据理解与探索"><a href="#一、数据理解与探索" class="headerlink" title="一、数据理解与探索"></a><strong>一、数据理解与探索</strong></h3><h4 id="1-数据概览"><a href="#1-数据概览" class="headerlink" title="1. 数据概览"></a>1. 数据概览</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'data.csv'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># 查看前5行</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># 数据类型和缺失值统计</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># 数值型特征统计分布</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession
spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>csv<span class="token punctuation">(</span><span class="token string">'data.csv'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> inferSchema<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># 查看数据模式</span>
df<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>              <span class="token comment"># 显示前5行</span>
df<span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 统计分布</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-可视化分析"><a href="#2-可视化分析" class="headerlink" title="2. 可视化分析"></a>2. 可视化分析</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Matplotlib/Seaborn)</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns

<span class="token comment"># 数值型特征分布</span>
sns<span class="token punctuation">.</span>histplot<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> kde<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 类别型特征分布</span>
sns<span class="token punctuation">.</span>countplot<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token string">'gender'</span><span class="token punctuation">,</span> data<span class="token operator">=</span>df<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 相关性矩阵</span>
corr_matrix <span class="token operator">=</span> df<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span>
sns<span class="token punctuation">.</span>heatmap<span class="token punctuation">(</span>corr_matrix<span class="token punctuation">,</span> annot<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="二、数据清洗"><a href="#二、数据清洗" class="headerlink" title="二、数据清洗"></a><strong>二、数据清洗</strong></h3><h4 id="1-处理缺失值"><a href="#1-处理缺失值" class="headerlink" title="1. 处理缺失值"></a>1. 处理缺失值</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token comment"># 删除缺失值</span>
df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 填充缺失值（均值/众数）</span>
df<span class="token punctuation">[</span><span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'gender'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'gender'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> mean<span class="token punctuation">,</span> col

<span class="token comment"># 计算均值</span>
mean_income <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>mean<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">'income'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>na<span class="token punctuation">.</span>fill<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'income'</span><span class="token punctuation">:</span> mean_income<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment"># 删除缺失值</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>na<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-处理异常值"><a href="#2-处理异常值" class="headerlink" title="2. 处理异常值"></a>2. 处理异常值</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token comment"># Z-Score方法</span>
<span class="token keyword">from</span> scipy <span class="token keyword">import</span> stats
z_scores <span class="token operator">=</span> stats<span class="token punctuation">.</span>zscore<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token punctuation">(</span>z_scores <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>z_scores <span class="token operator">></span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># IQR方法</span>
Q1 <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>quantile<span class="token punctuation">(</span><span class="token number">0.25</span><span class="token punctuation">)</span>
Q3 <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>quantile<span class="token punctuation">(</span><span class="token number">0.75</span><span class="token punctuation">)</span>
IQR <span class="token operator">=</span> Q3 <span class="token operator">-</span> Q1
df <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>Q1 <span class="token operator">-</span> <span class="token number">1.5</span><span class="token operator">*</span>IQR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">></span> <span class="token punctuation">(</span>Q3 <span class="token operator">+</span> <span class="token number">1.5</span><span class="token operator">*</span>IQR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> avg<span class="token punctuation">,</span> stddev

<span class="token comment"># 计算统计量</span>
stats <span class="token operator">=</span> df<span class="token punctuation">.</span>select<span class="token punctuation">(</span>avg<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stddev<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
mean_age <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
std_age <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token operator">></span> mean_age <span class="token operator">-</span> <span class="token number">3</span><span class="token operator">*</span>std_age<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> mean_age <span class="token operator">+</span> <span class="token number">3</span><span class="token operator">*</span>std_age<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="三、特征构建"><a href="#三、特征构建" class="headerlink" title="三、特征构建"></a><strong>三、特征构建</strong></h3><h4 id="1-数值型特征处理"><a href="#1-数值型特征处理" class="headerlink" title="1. 数值型特征处理"></a>1. 数值型特征处理</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token comment"># 分箱（离散化）</span>
df<span class="token punctuation">[</span><span class="token string">'age_bin'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>cut<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'child'</span><span class="token punctuation">,</span> <span class="token string">'youth'</span><span class="token punctuation">,</span> <span class="token string">'adult'</span><span class="token punctuation">,</span> <span class="token string">'senior'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 多项式特征</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> PolynomialFeatures
poly <span class="token operator">=</span> PolynomialFeatures<span class="token punctuation">(</span>degree<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> interaction_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
poly_features <span class="token operator">=</span> poly<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> Bucketizer

<span class="token comment"># 分箱</span>
bucketizer <span class="token operator">=</span> Bucketizer<span class="token punctuation">(</span>splits<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputCol<span class="token operator">=</span><span class="token string">'age'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'age_bin'</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> bucketizer<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-类别型特征编码"><a href="#2-类别型特征编码" class="headerlink" title="2. 类别型特征编码"></a>2. 类别型特征编码</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token comment"># One-Hot Encoding</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>get_dummies<span class="token punctuation">(</span>df<span class="token punctuation">,</span> columns<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'gender'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># Label Encoding</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder
le <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'city'</span><span class="token punctuation">]</span> <span class="token operator">=</span> le<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> StringIndexer<span class="token punctuation">,</span> OneHotEncoder

<span class="token comment"># StringIndexer</span>
indexer <span class="token operator">=</span> StringIndexer<span class="token punctuation">(</span>inputCol<span class="token operator">=</span><span class="token string">'gender'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'gender_index'</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> indexer<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

<span class="token comment"># OneHotEncoder</span>
encoder <span class="token operator">=</span> OneHotEncoder<span class="token punctuation">(</span>inputCol<span class="token operator">=</span><span class="token string">'gender_index'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'gender_vec'</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-时间序列特征"><a href="#3-时间序列特征" class="headerlink" title="3. 时间序列特征"></a>3. 时间序列特征</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
df<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'year'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>year
df<span class="token punctuation">[</span><span class="token string">'day_of_week'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'date'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt<span class="token punctuation">.</span>dayofweek

<span class="token comment"># 滑动窗口统计</span>
df<span class="token punctuation">[</span><span class="token string">'7d_avg'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'sales'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> year<span class="token punctuation">,</span> dayofweek<span class="token punctuation">,</span> window

df <span class="token operator">=</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'year'</span><span class="token punctuation">,</span> year<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'day_of_week'</span><span class="token punctuation">,</span> dayofweek<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 窗口函数</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>window <span class="token keyword">import</span> Window
window_spec <span class="token operator">=</span> Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">'date'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rowsBetween<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'7d_avg'</span><span class="token punctuation">,</span> avg<span class="token punctuation">(</span><span class="token string">'sales'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>over<span class="token punctuation">(</span>window_spec<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="四、特征变换"><a href="#四、特征变换" class="headerlink" title="四、特征变换"></a><strong>四、特征变换</strong></h3><h4 id="1-标准化-归一化"><a href="#1-标准化-归一化" class="headerlink" title="1. 标准化&#x2F;归一化"></a>1. 标准化&#x2F;归一化</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler<span class="token punctuation">,</span> MinMaxScaler

scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'income_scaled'</span><span class="token punctuation">]</span> <span class="token operator">=</span> scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

minmax <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'age_normalized'</span><span class="token punctuation">]</span> <span class="token operator">=</span> minmax<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> StandardScaler<span class="token punctuation">,</span> MinMaxScaler
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml <span class="token keyword">import</span> Pipeline

scaler <span class="token operator">=</span> StandardScaler<span class="token punctuation">(</span>inputCol<span class="token operator">=</span><span class="token string">'income'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'income_scaled'</span><span class="token punctuation">)</span>
pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span>stages<span class="token operator">=</span><span class="token punctuation">[</span>scaler<span class="token punctuation">]</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pipeline<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-非线性变换"><a href="#2-非线性变换" class="headerlink" title="2. 非线性变换"></a>2. 非线性变换</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

df<span class="token punctuation">[</span><span class="token string">'log_income'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log1p<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'income'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'sqrt_age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> log1p<span class="token punctuation">,</span> sqrt

df <span class="token operator">=</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'log_income'</span><span class="token punctuation">,</span> log1p<span class="token punctuation">(</span><span class="token string">'income'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">'sqrt_age'</span><span class="token punctuation">,</span> sqrt<span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="五、特征选择"><a href="#五、特征选择" class="headerlink" title="五、特征选择"></a><strong>五、特征选择</strong></h3><h4 id="1-过滤法"><a href="#1-过滤法" class="headerlink" title="1. 过滤法"></a>1. 过滤法</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> VarianceThreshold<span class="token punctuation">,</span> SelectKBest<span class="token punctuation">,</span> f_classif

<span class="token comment"># 低方差过滤</span>
selector <span class="token operator">=</span> VarianceThreshold<span class="token punctuation">(</span>threshold<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
df_selected <span class="token operator">=</span> selector<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span>

<span class="token comment"># 基于统计检验</span>
selector <span class="token operator">=</span> SelectKBest<span class="token punctuation">(</span>f_classif<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
X_new <span class="token operator">=</span> selector<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> ChiSqSelector

selector <span class="token operator">=</span> ChiSqSelector<span class="token punctuation">(</span>numTopFeatures<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> featuresCol<span class="token operator">=</span><span class="token string">'features'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'selected'</span><span class="token punctuation">,</span> labelCol<span class="token operator">=</span><span class="token string">'label'</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> selector<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
df <span class="token operator">=</span> model<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-包裹法（递归特征消除）"><a href="#2-包裹法（递归特征消除）" class="headerlink" title="2. 包裹法（递归特征消除）"></a>2. 包裹法（递归特征消除）</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> RFE
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LogisticRegression

rfe <span class="token operator">=</span> RFE<span class="token punctuation">(</span>estimator<span class="token operator">=</span>LogisticRegression<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n_features_to_select<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
X_rfe <span class="token operator">=</span> rfe<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-嵌入法（基于模型）"><a href="#3-嵌入法（基于模型）" class="headerlink" title="3. 嵌入法（基于模型）"></a>3. 嵌入法（基于模型）</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestClassifier

model <span class="token operator">=</span> RandomForestClassifier<span class="token punctuation">(</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
importances <span class="token operator">=</span> model<span class="token punctuation">.</span>feature_importances_<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="六、特征降维"><a href="#六、特征降维" class="headerlink" title="六、特征降维"></a><strong>六、特征降维</strong></h3><h4 id="1-PCA"><a href="#1-PCA" class="headerlink" title="1. PCA"></a>1. PCA</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>decomposition <span class="token keyword">import</span> PCA

pca <span class="token operator">=</span> PCA<span class="token punctuation">(</span>n_components<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">)</span>  <span class="token comment"># 保留95%方差</span>
X_pca <span class="token operator">=</span> pca<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>feature <span class="token keyword">import</span> PCA

pca <span class="token operator">=</span> PCA<span class="token punctuation">(</span>k<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> inputCol<span class="token operator">=</span><span class="token string">'features'</span><span class="token punctuation">,</span> outputCol<span class="token operator">=</span><span class="token string">'pca_features'</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> pca<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>df<span class="token punctuation">)</span>
df <span class="token operator">=</span> model<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-t-SNE"><a href="#2-t-SNE" class="headerlink" title="2. t-SNE"></a>2. t-SNE</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Scikit-Learn)</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>manifold <span class="token keyword">import</span> TSNE

tsne <span class="token operator">=</span> TSNE<span class="token punctuation">(</span>n_components<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
X_tsne <span class="token operator">=</span> tsne<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="七、特征存储"><a href="#七、特征存储" class="headerlink" title="七、特征存储"></a><strong>七、特征存储</strong></h3><h4 id="保存处理后的数据"><a href="#保存处理后的数据" class="headerlink" title="保存处理后的数据"></a>保存处理后的数据</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Python (Pandas)</span>
df<span class="token punctuation">.</span>to_parquet<span class="token punctuation">(</span><span class="token string">'processed_data.parquet'</span><span class="token punctuation">)</span>

<span class="token comment"># PySpark</span>
df<span class="token punctuation">.</span>write<span class="token punctuation">.</span>parquet<span class="token punctuation">(</span><span class="token string">'hdfs://path/to/processed_data'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="八、高级技巧"><a href="#八、高级技巧" class="headerlink" title="八、高级技巧"></a><strong>八、高级技巧</strong></h3><h4 id="1-自动化特征工程"><a href="#1-自动化特征工程" class="headerlink" title="1. 自动化特征工程"></a>1. 自动化特征工程</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 使用FeatureTools</span>
<span class="token keyword">import</span> featuretools <span class="token keyword">as</span> ft

es <span class="token operator">=</span> ft<span class="token punctuation">.</span>EntitySet<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'data'</span><span class="token punctuation">)</span>
es <span class="token operator">=</span> es<span class="token punctuation">.</span>entity_from_dataframe<span class="token punctuation">(</span>entity_id<span class="token operator">=</span><span class="token string">'main'</span><span class="token punctuation">,</span> dataframe<span class="token operator">=</span>df<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token string">'id'</span><span class="token punctuation">)</span>

<span class="token comment"># 自动生成特征</span>
feature_matrix<span class="token punctuation">,</span> features <span class="token operator">=</span> ft<span class="token punctuation">.</span>dfs<span class="token punctuation">(</span>entityset<span class="token operator">=</span>es<span class="token punctuation">,</span> target_entity<span class="token operator">=</span><span class="token string">'main'</span><span class="token punctuation">,</span> max_depth<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-处理高基数类别特征"><a href="#2-处理高基数类别特征" class="headerlink" title="2. 处理高基数类别特征"></a>2. 处理高基数类别特征</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 目标编码（Target Encoding）</span>
<span class="token keyword">from</span> category_encoders <span class="token keyword">import</span> TargetEncoder

encoder <span class="token operator">=</span> TargetEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
df<span class="token punctuation">[</span><span class="token string">'city_encoded'</span><span class="token punctuation">]</span> <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span>

<span class="token comment"># PySpark实现需手动编码</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> mean

target_mean <span class="token operator">=</span> df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">'city'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>mean<span class="token punctuation">(</span><span class="token string">'label'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">'city_target_encoded'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>join<span class="token punctuation">(</span>target_mean<span class="token punctuation">,</span> on<span class="token operator">=</span><span class="token string">'city'</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h3><p>特征工程需要结合具体业务场景灵活调整，核心原则包括：</p>
<ol>
<li>充分理解数据分布和业务含义</li>
<li>优先处理数据质量问题（缺失值、异常值）</li>
<li>通过特征交叉、变换挖掘隐藏信息</li>
<li>使用自动化工具加速实验过程</li>
<li>持续监控特征在生产环境的表现</li>
</ol>
<p>建议将特征工程代码封装为可复用的Pipeline，便于后续维护和自动化部署。</p>

    </div>
  </article>
</div>
  </main>

  <footer>
    <p>
      &copy; 2025 Shark Blog 
      <a href="https://github.com/eddiehex/hexo-geek-source" target="_blank">
        <i class="fab fa-github"></i>
      </a>
    </p>
  </footer>

  <script src="/js/search.js"></script>
  <script src="/js/main.js"></script>
  <script src="/js/copy-code.js"></script>
  <script src="/js/prism.js"></script>
  <script src="/js/toc-highlight.js"></script>
  <script src="/js/mobile-menu.js"></script>
</body>
</html>
